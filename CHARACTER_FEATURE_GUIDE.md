# 角色自动提取功能使用指南

## 快速开始

### 步骤1：准备原始素材
1. 进入Studio项目，选择一个Episode
2. 在"原始输入"Tab中填写素材内容

### 步骤2：生成脚本目标
1. 切换到"目标确定"Tab
2. 选择LLM提供商和模型
3. 配置或编辑System Prompt（确保包含JSON格式要求）
4. 点击"生成目标"按钮
5. 等待LLM生成完成

### 步骤3：自动提取角色
生成成功后，系统会：
- ✅ 自动解析返回的JSON数据
- ✅ 提取所有角色信息（名称和外观描述）
- ✅ 在角色库中创建角色记录
- ✅ 显示提取结果提示

**提示信息示例**：
```
🎭 已提取 2 个角色（新建 2 个，更新 0 个）
```

### 步骤4：查看和管理角色
1. 切换到"背景设定"Tab
2. 滚动到"角色库"部分
3. 查看自动提取的角色列表

每个角色卡片显示：
- 角色名称
- 角色描述（标注"从集 #X 自动提取"）
- 外观描述（Appearance Prompt）
- 关联状态

### 步骤5：关联演员（可选）
1. 点击角色卡片上的"关联演员"按钮
2. 在弹出对话框中选择一个演员
3. 确认关联成功

关联后的功能：
- **同步**：从演员表同步最新数据
- **取消关联**：解除与演员的关联

## System Prompt 配置

确保你的System Prompt要求LLM返回包含以下结构的JSON：

```json
{
  "styleSettings": "...",
  "aestheticSettings": "...",
  "learningPoint": "...",
  "shots": [
    {
      "shotNumber": 1,
      "character": "角色名称",
      "scenePrompt": "...",
      "characterPrompt": "角色外观和动作描述",
      "dialogue": "..."
    }
  ]
}
```

**关键字段**：
- `shots` - 镜头数组（必需）
- `character` - 角色名称（每个镜头必需）
- `characterPrompt` - 角色外观描述（会被提取到角色库）

## 示例工作流

### 示例1：英语对话教学短片

**原始输入**：
```
场景：面包房
对话内容：学习常见面包的英文名称
角色：面包师（Baker）和顾客（Customer）
```

**生成的JSON**（部分）：
```json
{
  "shots": [
    {
      "character": "Baker",
      "characterPrompt": "Baker穿着巴伐利亚风格的围裙连衣裙，头发整齐地盘成发髻，站在柜台后面，面带职业微笑"
    },
    {
      "character": "Customer",
      "characterPrompt": "Customer穿着简约的黑色连衣裙，长发自然垂落，站在柜台前，眼神看向柜台里的面包"
    }
  ]
}
```

**提取结果**：
- ✅ 创建角色"Baker"，外观：巴伐利亚风格围裙...
- ✅ 创建角色"Customer"，外观：黑色连衣裙...

### 示例2：关联演员

假设你的演员表中有：
- Alice（女演员，专业教师形象）
- Bob（男演员，友好邻居形象）

你可以：
1. 将"Customer"角色关联到Alice
2. 将"Baker"角色关联到Bob（如果改为男性面包师）

关联后，在镜头编排时可以直接使用演员的参考图片和详细资料。

## 常见问题

### Q1: LLM没有返回纯JSON怎么办？
**A**: 系统会自动处理！提取功能会从返回内容中寻找第一个`{`到最后一个`}`之间的内容作为JSON。

**示例**：
```
以下是根据您的要求生成的脚本：

{"styleSettings": "...", "shots": [...]}

希望这个脚本符合您的需求。
```
系统会自动提取中间的JSON部分。

### Q2: 角色已存在会重复创建吗？
**A**: 不会！系统会检查角色名称（projectId + name），如果已存在则不会重复创建。

### Q3: 如果角色外观描述更新了怎么办？
**A**: 如果现有角色的`appearancePrompt`为空，系统会自动更新。如果已有内容，则保持不变（避免覆盖手动编辑）。

### Q4: 可以手动创建角色吗？
**A**: 可以！点击"新建角色"按钮手动创建，不影响自动提取功能。

### Q5: 关联演员有什么好处？
**A**:
- 可以复用演员的参考图片
- 可以从演员表同步最新资料
- 便于统一管理演员信息
- 未来可以支持更多演员相关功能（如视频片段库）

## 技术细节

### JSON提取算法
```typescript
function extractJsonFromString(str: string): string {
  const firstBrace = str.indexOf('{')
  const lastBrace = str.lastIndexOf('}')

  if (firstBrace === -1 || lastBrace === -1 || firstBrace >= lastBrace) {
    return str
  }

  return str.substring(firstBrace, lastBrace + 1)
}
```

### 角色去重逻辑
- 基于 `projectId + name` 唯一性约束
- 同一项目内，同名角色只会创建一次
- 不同项目可以有同名角色

### 数据流
```
LLM返回 → 提取JSON → 解析shots → 提取角色 → 创建/更新角色 → 显示提示
```

## 最佳实践

1. **System Prompt设计**
   - 明确要求返回JSON格式
   - 指定必需的字段（shots, character, characterPrompt）
   - 可以要求LLM保持角色外观一致性

2. **角色命名**
   - 使用简洁明确的角色名（如Baker, Customer）
   - 避免使用特殊字符
   - 保持命名一致性

3. **外观描述**
   - 越详细越好，有助于后续AI生成
   - 包含服装、发型、表情、姿态等
   - 与风格设定保持一致

4. **演员关联**
   - 优先关联常用演员
   - 定期同步演员数据
   - 合理组织演员库

## 故障排除

### 问题：提示"无法解析目标JSON"
**可能原因**：
- LLM返回格式不正确
- 缺少必需的字段

**解决方案**：
1. 检查"原始返回数据"查看实际内容
2. 优化System Prompt，更明确地要求JSON格式
3. 尝试不同的LLM模型

### 问题：角色没有被提取
**可能原因**：
- shots数组为空
- character或characterPrompt字段缺失

**解决方案**：
1. 展开"原始返回数据"检查JSON结构
2. 确保每个shot都包含character和characterPrompt字段

### 问题：关联演员失败
**可能原因**：
- 演员不存在
- 权限问题

**解决方案**：
1. 前往媒体浏览器确认演员存在
2. 刷新页面重试

## 更新日志

### v1.0 (2025-10-19)
- ✨ 新增：自动从目标JSON提取角色
- ✨ 新增：角色关联演员功能
- ✨ 新增：智能JSON提取（支持带说明文字）
- ✨ 新增：角色去重逻辑
- ✨ 新增：提取结果提示
- 🎨 优化：角色库UI展示
- 🎨 优化：关联状态可视化
