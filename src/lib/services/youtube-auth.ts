import { Logger } from '~/lib/utils/logger'
import { browserManager } from './browser-manager'
import type { Page } from 'puppeteer'
import * as fs from 'fs/promises'
import * as path from 'path'
import os from 'os'
import { ConfigManager } from '~/lib/utils/config'

export interface YouTubeCookie {
  name: string
  value: string
  domain: string
  path: string
  expires?: number
  httpOnly?: boolean
  secure?: boolean
  sameSite?: 'Strict' | 'Lax' | 'None'
}

/**
 * YouTubeè®¤è¯æœåŠ¡
 * é€šè¿‡æ‰‹åŠ¨è®¾ç½®Cookieæ–‡ä»¶æ¥æ”¯æŒéœ€è¦ç™»å½•çš„YouTubeè§†é¢‘
 */
export class YouTubeAuthService {
  private static instance: YouTubeAuthService
  private cookieFilePath: string
  
  private constructor() {
    // ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„data/cookies/ä¸­
    this.cookieFilePath = path.join(process.cwd(), 'data', 'cookies', 'youtube_cookies.txt')
  }

  public static getInstance(): YouTubeAuthService {
    if (!YouTubeAuthService.instance) {
      YouTubeAuthService.instance = new YouTubeAuthService()
    }
    return YouTubeAuthService.instance
  }

  /**
   * æ‰‹åŠ¨è®¾ç½®Cookieï¼ˆä»å¤–éƒ¨ç²˜è´´ï¼‰
   * @param cookiesText Netscapeæ ¼å¼æˆ–æµè§ˆå™¨åŸç”ŸCookieå­—ç¬¦ä¸²
   */
  async setCookiesManually(cookiesText: string): Promise<boolean> {
    try {
      Logger.info('ğŸ“‹ æ­£åœ¨è®¾ç½®æ‰‹åŠ¨æä¾›çš„YouTube Cookie...')
      
      // ç¡®ä¿cookieç›®å½•å­˜åœ¨
      await fs.mkdir(path.dirname(this.cookieFilePath), { recursive: true })
      
      let cookieContent = cookiesText.trim()

      // å¦‚æœæ˜¯æµè§ˆå™¨Cookieå­—ç¬¦ä¸²æ ¼å¼ï¼Œç®€å•è½¬æ¢ä¸ºNetscapeæ ¼å¼
      // æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–è½¬æ¢ï¼Œå¯¹äºå¤æ‚åœºæ™¯å¯èƒ½ä¸å®Œç¾ï¼Œä½†èƒ½è¦†ç›–å¤§éƒ¨åˆ†æƒ…å†µ
      if (!cookieContent.includes('# Netscape HTTP Cookie File') && cookieContent.includes('=')) {
        Logger.info('...æ£€æµ‹åˆ°æµè§ˆå™¨åŸç”ŸCookieå­—ç¬¦ä¸²ï¼Œæ­£åœ¨è½¬æ¢ä¸ºNetscapeæ ¼å¼')
        const netscapeLines = [
          '# Netscape HTTP Cookie File',
          '# Generated by yt-dlpservice',
          ''
        ]
        
        const cookies = cookieContent.split(';').map(c => c.trim())
        for (const cookie of cookies) {
          if (cookie.includes('=')) {
            const [name, ...valueParts] = cookie.split('=')
            const value = valueParts.join('=')
            // ä¸ºä¸»è¦YouTubeåŸŸååˆ›å»ºæ¡ç›®
            if (name && name.trim()) {
              netscapeLines.push(`.youtube.com\tTRUE\t/\tTRUE\t${Math.floor(Date.now() / 1000) + 31536000}\t${name.trim()}\t${value.trim()}`)
            }
          }
        }
        cookieContent = netscapeLines.join('\n')
      }
      
      // ä¿å­˜cookieæ–‡ä»¶
      await fs.writeFile(this.cookieFilePath, cookieContent, 'utf8')
      
      Logger.info(`âœ… Cookieå·²æˆåŠŸä¿å­˜åˆ°: ${this.cookieFilePath}`)
      return true
    } catch (error: any) {
      Logger.error(`ä¿å­˜Cookieå¤±è´¥: ${error.message}`)
      return false
    }
  }

  /**
   * æ£€æŸ¥Cookieæ–‡ä»¶æ˜¯å¦å­˜åœ¨
   */
  async hasCookies(): Promise<boolean> {
    try {
      await fs.access(this.cookieFilePath)
      const stats = await fs.stat(this.cookieFilePath)
      // ç®€å•æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œå¤§äº0å³å¯
      return stats.size > 0
    } catch {
      return false
    }
  }

  /**
   * ç¡®ä¿æœ‰æœ‰æ•ˆçš„Cookieæ–‡ä»¶å­˜åœ¨
   * åœ¨å½“å‰æ¨¡å‹ä¸‹ï¼Œæˆ‘ä»¬ä¿¡ä»»ç”¨æˆ·æä¾›çš„æ‰‹åŠ¨Cookieæ˜¯æœ‰æ•ˆçš„
   */
  async ensureValidCookies(): Promise<boolean> {
    const exists = await this.hasCookies()
    if (exists) {
      Logger.info('âœ… æ£€æµ‹åˆ°YouTube Cookieæ–‡ä»¶ï¼Œå°†ç”¨äºåç»­è¯·æ±‚')
    } else {
      Logger.warn('âš ï¸ æœªæ‰¾åˆ°YouTube Cookieæ–‡ä»¶ï¼Œéƒ¨åˆ†è§†é¢‘å¯èƒ½æ— æ³•è®¿é—®')
    }
    return exists
  }

  /**
   * è·å–Cookieæ–‡ä»¶è·¯å¾„
   */
  getCookieFilePath(): string {
    return this.cookieFilePath
  }

  /**
   * è·å–é»˜è®¤Chromium Profileè·¯å¾„ï¼ˆä¾› --cookies-from-browser ä½¿ç”¨ï¼‰
   * ä¾‹å¦‚: chromium:/home/ubuntu/chrome-profile/Default
   */
  getDefaultBrowserProfilePath(): string {
    const home = os.homedir()
    return path.join(home, 'chrome-profile', 'Default')
  }

  async hasBrowserProfile(): Promise<boolean> {
    try {
      const p = this.getDefaultBrowserProfilePath()
      await fs.access(p)
      return true
    } catch {
      return false
    }
  }

  /**
   * æ¸…é™¤Cookie
   */
  async clearCookies(): Promise<void> {
    try {
      await fs.unlink(this.cookieFilePath)
      Logger.info('Cookieå·²æ¸…é™¤')
    } catch (error: any) {
      // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
      if (error.code !== 'ENOENT') {
        Logger.error(`æ¸…é™¤Cookieå¤±è´¥: ${error.message}`)
        throw error
      }
    }
  }

  /**
   * ç”ŸæˆCookieè®¾ç½®æŒ‡å—
   */
  generateCookieGuide(): string {
    return `
ğŸª YouTube Cookieè®¾ç½®æŒ‡å— (æœåŠ¡å™¨ç‰ˆ)

å½“é‡åˆ°éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„YouTubeè§†é¢‘æ—¶ï¼Œä½ éœ€è¦æä¾›Cookieã€‚

**æ“ä½œæ­¥éª¤:**

1. **åœ¨ä½ çš„ç”µè„‘æµè§ˆå™¨ä¸Šæ“ä½œ:**
   - æ‰“å¼€Chromeæˆ–Firefoxï¼Œç™»å½•ä½ çš„YouTubeè´¦å·ã€‚
   - è®¿é—®ä»»æ„YouTubeé¡µé¢ã€‚
   - å®‰è£…æµè§ˆå™¨æ‰©å±• "Cookie-Editor"ã€‚
   - ç‚¹å‡»æ‰©å±•å›¾æ ‡ï¼Œé€‰æ‹© "Export" -> "Export as Netscape" -> "Copy to Clipboard"ã€‚

2. **åœ¨æœåŠ¡å™¨ç®¡ç†é¡µé¢æ“ä½œ:**
   - è®¿é—®æœ¬åº”ç”¨çš„ /admin/youtube-auth é¡µé¢ã€‚
   - å°†å¤åˆ¶çš„Cookieå†…å®¹ç²˜è´´åˆ° "æ‰‹åŠ¨è®¾ç½®Cookie" çš„æ–‡æœ¬æ¡†ä¸­ã€‚
   - ç‚¹å‡» "è®¾ç½®Cookie" æŒ‰é’®ã€‚

**å¤‡ç”¨æ–¹æ¡ˆ: å‘½ä»¤è¡Œ**

é€šè¿‡SSHç™»å½•åˆ°æœåŠ¡å™¨ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤:
node scripts/youtube-auth-cli.js --set-cookie

ç„¶åå°†å¤åˆ¶çš„Cookieå†…å®¹ç²˜è´´è¿›å»å³å¯ã€‚

**Cookieæ–‡ä»¶ä½ç½®:**
${this.cookieFilePath}
    `.trim()
  }
}

export const youtubeAuthService = YouTubeAuthService.getInstance()