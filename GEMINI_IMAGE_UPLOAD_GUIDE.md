# Gemini 2.5 Flash Image - 图片上传使用指南

## 📸 功能概述

Gemini 2.5 Flash Image 模型支持两种生成模式：
1. **文生图** (Text-to-Image): 仅使用文字提示词生成图片
2. **图生图** (Image-to-Image): 上传1-3张图片 + 文字提示词进行编辑、合成或风格转换

## 🎯 支持的图片上传场景

### 1. 图像编辑 (Image Editing)
上传一张图片，用文字描述你想要的修改：

**示例**：
- 上传猫的照片 → "在猫头上添加一顶小巫师帽"
- 上传客厅照片 → "把蓝色沙发换成棕色皮质切斯特菲尔德沙发"
- 上传人物照片 → "将背景更换为巴黎埃菲尔铁塔"

### 2. 风格转换 (Style Transfer)
上传图片并指定艺术风格：

**示例**：
- 上传城市夜景照片 → "将这张照片转换为梵高《星空》的艺术风格"
- 上传人像照片 → "转换为水彩画风格"
- 上传风景照片 → "转换为赛博朋克风格"

### 3. 多图合成 (Multi-Image Composition)
上传2-3张图片进行创意合成：

**示例**：
- 上传服装图 + 模特图 → "让模特穿上这件衣服，生成电商照片"
- 上传Logo + 人物照 → "将Logo印在T恤上"
- 上传多个元素 → "将这些元素组合成海报"

### 4. Inpainting (语义蒙版)
通过自然语言描述要编辑的区域：

**示例**：
- 上传客厅图 → "只改变沙发颜色，保持其他不变"
- 上传照片 → "移除背景中的路人"

## 📱 在Admin面板中使用图片上传

### 位置
访问: `http://localhost:3000/admin/ai-generation`

### 步骤

#### 1. 选择模型
1. 在"输出类型"选择 **图片 (IMAGE)**
2. 在"供应商"选择 **Gemini Official**
3. 在"模型"选择 **Gemini 2.5 Flash (Image)**

#### 2. 上传图片 (两种方式)

**方式A: 本地文件上传**
1. 找到"输入图片 (可选)"区域
2. 点击 **[+] 上传图片** 按钮
3. 选择本地图片文件 (支持PNG/JPG/WebP)
4. 系统自动上传到S3并显示缩略图
5. 最多上传 **5张图片**（Gemini建议使用1-3张）

**方式B: URL输入**
1. 在图片上传区域下方找到"或输入图片URL"
2. 粘贴图片的公开URL
3. 点击"添加"按钮
4. 图片会显示在上传列表中

#### 3. 管理已上传图片
- **预览**: 点击缩略图查看大图
- **删除**: 鼠标悬停在图片上，点击右上角的删除按钮 (×)
- **顺序**: 第1张图为主图，其他为辅助图

#### 4. 编写提示词
根据上传的图片编写对应的提示词：

**示例提示词格式**：
```
[如果上传了图片]
使用提供的图片，[描述想要的修改/效果]。
保持[想保留的元素]，[具体的修改要求]。

[如果没上传图片 - 纯文生图]
[详细描述想要生成的图片内容、风格、细节等]
```

#### 5. 配置参数
- **画面比例**: 选择合适的尺寸（1:1, 16:9, 9:16等）
- **响应模式**:
  - "图片和文字": 返回图片+AI的文字说明
  - "仅图片": 只返回生成的图片

#### 6. 生成
1. 点击 **生成** 按钮
2. 等待生成完成（通常10-30秒）
3. 在"任务历史"查看结果
4. 点击图片可下载或查看大图

## 🎬 在Studio中使用图片上传

### 位置
在Studio项目中的"镜头"(Shots)标签页

### 步骤

#### 1. 创建或选择镜头
1. 打开项目
2. 选择集数
3. 创建或选择一个镜头

#### 2. 打开AI生成面板
点击"生成关键帧"或"AI生成"按钮

#### 3. 上传参考图
与Admin面板相同的图片上传功能：
- 本地上传或URL输入
- 最多5张图片
- 支持预览和删除

#### 4. 使用快捷提示词（可选）
Studio提供了快捷填充功能：
- 点击"使用镜头标题"
- 点击"使用场景描述"
- 点击"使用角色信息"

#### 5. 组合提示词
结合上传的图片和快捷提示词，编写完整提示：

**示例**：
```
[镜头标题: 主角走进咖啡馆]
[上传了咖啡馆内部照片]

提示词: 使用提供的咖啡馆照片，添加一位穿着黑色风衣的女性角色
正在推门进入。保持咖啡馆的温馨氛围和灯光，确保人物融入场景。
```

#### 6. 生成和管理
- 生成的图片自动关联到当前镜头
- 可以作为关键帧保存
- 可以继续迭代优化

## 💡 实用技巧

### 图片上传最佳实践

1. **图片质量**
   - 推荐分辨率: 1024x1024 以上
   - 文件大小: 小于10MB
   - 格式: PNG (无损) > JPG > WebP

2. **图片数量建议**
   - **1张图**: 编辑、风格转换、背景替换
   - **2张图**: 人物换装、元素合成
   - **3张图**: 复杂场景合成（较少使用）

3. **图片顺序**
   - 第1张: 主要参考图（最重要）
   - 第2张: 辅助元素
   - 第3张: 风格参考或其他元素

### 提示词编写技巧

#### 图片编辑提示词模板
```
使用提供的[图片类型]，[具体修改动作]。

要求:
- 保持[要保留的元素]不变
- [新增/修改/删除]的元素: [详细描述]
- 整体风格: [风格描述]
- 光照和阴影要自然融合
```

#### 风格转换提示词模板
```
将提供的照片转换为[艺术家名字]的[作品名称]艺术风格。

保留原图的构图和主要元素，但使用[具体的艺术技法描述]，
色调以[颜色描述]为主。
```

#### 多图合成提示词模板
```
创建一张[用途]照片。

使用第一张图片中的[元素A]和第二张图片中的[元素B]，
将它们合成到[场景描述]中。

确保:
- 光照匹配
- 透视正确
- 元素自然融合
```

## 🔍 示例场景

### 场景1: 产品照片换背景

**上传**:
- 图1: 白底产品照片

**提示词**:
```
使用提供的产品照片，将白色背景替换为温馨的家居环境。
产品摆放在木质桌面上，背景是模糊的客厅，有柔和的自然光
从左侧照入。保持产品的清晰度和原有光影。
```

**参数**:
- 画面比例: 4:3
- 响应模式: 仅图片

---

### 场景2: 人物照片风格化

**上传**:
- 图1: 人物肖像照片

**提示词**:
```
将这张肖像照片转换为专业的油画风格。使用印象派的笔触技法，
色彩鲜明但柔和，背景用渐变的暖色调。保持人物的面部特征
和表情不变。
```

**参数**:
- 画面比例: 3:4
- 响应模式: 图片和文字

---

### 场景3: 服装电商图合成

**上传**:
- 图1: 服装平铺图
- 图2: 模特全身照

**提示词**:
```
创建一张专业电商时尚照片。让图2中的模特穿上图1中的服装，
拍摄角度为全身照，模特站在简约的室外环境中，有自然光照射。
服装的褶皱和光影要符合模特的姿态。
```

**参数**:
- 画面比例: 3:4
- 响应模式: 仅图片

---

### 场景4: 室内设计预览

**上传**:
- 图1: 现有客厅照片

**提示词**:
```
使用提供的客厅照片，只改变沙发的设计。将当前的沙发替换为
深灰色现代简约风格的L型沙发，配有浅色抱枕。保持房间的
其他家具、墙面颜色和光线完全不变。
```

**参数**:
- 画面比例: 16:9
- 响应模式: 仅图片

## ⚠️ 常见问题

### Q1: 上传后图片不显示？
**A**:
- 检查图片格式（支持PNG/JPG/WebP）
- 确认文件大小 < 10MB
- 如果是URL，确保链接公开可访问
- 查看浏览器控制台错误信息

### Q2: 生成结果没有使用上传的图片？
**A**:
- 确认模型配置中 `inputCapabilities` 包含 `"image-input"`
- 检查提示词是否明确提到"使用提供的图片"
- 确认图片已成功上传（显示缩略图）
- 尝试更具体的描述图片内容

### Q3: 图片编辑效果不理想？
**A**:
- 使用更详细的提示词描述期望的变化
- 明确说明要保留和修改的部分
- 尝试调整画面比例
- 可以多次生成选择最佳结果

### Q4: 多图合成结果不符合预期？
**A**:
- 确保图片质量和分辨率相近
- 在提示词中明确说明每张图的用途
- 描述期望的合成方式（叠加、替换、融合等）
- Gemini建议使用1-3张图，不要超过

### Q5: 可以上传多少张图片？
**A**:
- UI支持最多 **5张图片**
- Gemini建议使用 **1-3张图片** 以获得最佳效果
- 超过3张可能影响生成质量

## 🛠️ 技术细节

### 图片处理流程

```
用户上传图片
    ↓
[本地文件] → FileReader → Base64 → api.storage.uploadFile → S3 URL
[URL输入] → 验证格式 → 直接存储URL
    ↓
显示缩略图 (16x16 object-cover)
    ↓
用户点击生成
    ↓
收集所有图片URL → inputImages: string[]
    ↓
调用 generateMutation
    ↓
GeminiFlashImageAdapter.dispatch()
    ↓
downloadAndEncodeImage(url) → Base64
    ↓
构建 inlineData 部分发送给Gemini API
    ↓
接收Base64图片结果 → 转为DataURL → 显示给用户
```

### 支持的MIME类型
- `image/jpeg`
- `image/png`
- `image/gif`
- `image/webp`

### 图片限制
- 最大文件大小: 10MB
- 推荐分辨率: 1024x1024 或更高
- 最多图片数: 5张（UI限制），建议1-3张（模型性能）

## 📚 相关文档

- [Gemini集成文档](./GEMINI_INTEGRATION.md)
- [Gemini API官方文档](https://ai.google.dev/api/generate-images)
- [Admin AI生成页面源码](./src/app/admin/ai-generation/page.tsx)
- [Studio AI生成组件源码](./src/components/studio/ShotAIGenerationPanel.tsx)

---

**更新时间**: 2025-10-25
**版本**: 1.0
**状态**: ✅ 图片上传功能已完全集成并可用
