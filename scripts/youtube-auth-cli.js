#!/usr/bin/env node

/**
 * YouTubeè®¤è¯å‘½ä»¤è¡Œå·¥å…·
 * ä¸“ä¸ºUbuntuæœåŠ¡å™¨ç¯å¢ƒè®¾è®¡
 */

import { readFileSync, writeFileSync, existsSync, mkdirSync } from 'fs'
import { dirname, join } from 'path'
import { fileURLToPath } from 'url'
import { exec } from 'child_process'
import { promisify } from 'util'
import readline from 'readline'

const execAsync = promisify(exec)
const __dirname = dirname(fileURLToPath(import.meta.url))
const projectRoot = join(__dirname, '..')
const cookieDir = join(projectRoot, 'data', 'cookies')
const cookieFile = join(cookieDir, 'youtube_cookies.txt')

// åˆ›å»ºreadlineæ¥å£
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
})

const question = (query) => new Promise((resolve) => rl.question(query, resolve))

// é¢œè‰²è¾“å‡º
const colors = {
  red: '\x1b[31m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
  white: '\x1b[37m',
  reset: '\x1b[0m'
}

function colorLog(color, message) {
  console.log(`${colors[color]}${message}${colors.reset}`)
}

// æ£€æŸ¥Cookieæ–‡ä»¶çŠ¶æ€
function checkCookieStatus() {
  if (!existsSync(cookieFile)) {
    return { exists: false, message: 'Cookieæ–‡ä»¶ä¸å­˜åœ¨' }
  }

  const stats = require('fs').statSync(cookieFile)
  const now = Date.now()
  const fileAge = now - stats.mtime.getTime()
  const hoursAge = fileAge / (1000 * 60 * 60)
  
  return {
    exists: true,
    age: hoursAge,
    path: cookieFile,
    message: `Cookieæ–‡ä»¶å­˜åœ¨ï¼Œ${hoursAge.toFixed(1)}å°æ—¶å‰æ›´æ–°`
  }
}

// æµ‹è¯•yt-dlpä¸YouTubeçš„è¿é€šæ€§
async function testYouTubeConnection(testUrl = 'https://www.youtube.com/watch?v=dQw4w9WgXcQ') {
  colorLog('cyan', 'ğŸ§ª æµ‹è¯•YouTubeè¿é€šæ€§...')
  
  try {
    // ä¸ä½¿ç”¨Cookieæµ‹è¯•
    colorLog('blue', '1. æµ‹è¯•æ— Cookieè®¿é—®...')
    try {
      const { stdout: noCookieResult } = await execAsync(
        `yt-dlp --no-warnings --dump-json --quiet "${testUrl}" 2>/dev/null | head -1`,
        { timeout: 30000 }
      )
      
      if (noCookieResult.trim()) {
        colorLog('green', 'âœ… æ— Cookieå¯ä»¥è®¿é—®YouTube')
        return { needsCookie: false, testUrl }
      }
    } catch (error) {
      colorLog('yellow', 'âš ï¸ æ— Cookieæ— æ³•è®¿é—®YouTube')
    }

    // ä½¿ç”¨Cookieæµ‹è¯•
    if (existsSync(cookieFile)) {
      colorLog('blue', '2. æµ‹è¯•ä½¿ç”¨Cookieè®¿é—®...')
      try {
        const { stdout: cookieResult } = await execAsync(
          `yt-dlp --no-warnings --dump-json --cookies "${cookieFile}" --quiet "${testUrl}" 2>/dev/null | head -1`,
          { timeout: 30000 }
        )
        
        if (cookieResult.trim()) {
          const data = JSON.parse(cookieResult.trim())
          colorLog('green', 'âœ… ä½¿ç”¨Cookieå¯ä»¥è®¿é—®YouTube')
          colorLog('green', `   æ ‡é¢˜: ${data.title}`)
          colorLog('green', `   æ—¶é•¿: ${data.duration}ç§’`)
          colorLog('green', `   æ’­æ”¾é‡: ${data.view_count?.toLocaleString() || 'N/A'}`)
          return { needsCookie: true, working: true, testUrl, data }
        }
      } catch (error) {
        colorLog('red', 'âŒ Cookieæ— æ•ˆæˆ–å·²è¿‡æœŸ')
      }
    }

    return { needsCookie: true, working: false, testUrl }
  } catch (error) {
    colorLog('red', `æµ‹è¯•å¤±è´¥: ${error.message}`)
    return { error: error.message }
  }
}

// æ‰‹åŠ¨è®¾ç½®Cookie
async function setCookieManually() {
  colorLog('cyan', 'ğŸ“‹ æ‰‹åŠ¨è®¾ç½®YouTube Cookie')
  colorLog('white', 'è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è·å–Cookie:')
  console.log(`
1. åœ¨æœ¬åœ°æµè§ˆå™¨æ‰“å¼€ https://www.youtube.com
2. ç™»å½•ä½ çš„Googleè´¦å·
3. æ‰“å¼€å¼€å‘è€…å·¥å…· (F12)
4. è½¬åˆ° Network æ ‡ç­¾é¡µ
5. åˆ·æ–°é¡µé¢ï¼Œæ‰¾åˆ°ä»»æ„è¯·æ±‚
6. å³é”®ç‚¹å‡»è¯·æ±‚ -> Copy -> Copy as cURL
7. ä»cURLå‘½ä»¤ä¸­æå–Cookieä¿¡æ¯

æˆ–è€…ä½¿ç”¨æµè§ˆå™¨æ‰©å±•å¯¼å‡ºCookieä¸ºNetscapeæ ¼å¼
  `)

  const cookieInput = await question('è¯·ç²˜è´´Cookieå†…å®¹ (å¯ä»¥æ˜¯æµè§ˆå™¨Cookieå­—ç¬¦ä¸²æˆ–Netscapeæ ¼å¼): ')
  
  if (!cookieInput.trim()) {
    colorLog('red', 'âŒ æœªè¾“å…¥Cookieå†…å®¹')
    return false
  }

  try {
    // ç¡®ä¿ç›®å½•å­˜åœ¨
    if (!existsSync(cookieDir)) {
      mkdirSync(cookieDir, { recursive: true })
    }

    let cookieContent = cookieInput.trim()

    // å¦‚æœæ˜¯æµè§ˆå™¨Cookieå­—ç¬¦ä¸²æ ¼å¼ï¼Œè½¬æ¢ä¸ºNetscapeæ ¼å¼
    if (!cookieContent.includes('# Netscape HTTP Cookie File') && cookieContent.includes('=')) {
      colorLog('blue', 'ğŸ”„ è½¬æ¢Cookieæ ¼å¼...')
      
      const netscapeLines = [
        '# Netscape HTTP Cookie File',
        '# Generated by yt-dlpservice CLI',
        ''
      ]

      // è§£æCookieå­—ç¬¦ä¸²
      const cookies = cookieContent.split(';').map(c => c.trim())
      
      for (const cookie of cookies) {
        if (cookie.includes('=')) {
          const [name, value] = cookie.split('=', 2)
          // ç®€å•çš„Netscapeæ ¼å¼è¡Œ
          netscapeLines.push(`.youtube.com\tTRUE\t/\tTRUE\t${Math.floor(Date.now() / 1000) + 86400}\t${name.trim()}\t${value?.trim() || ''}`)
        }
      }

      cookieContent = netscapeLines.join('\n')
    }

    // ä¿å­˜Cookieæ–‡ä»¶
    writeFileSync(cookieFile, cookieContent, 'utf8')
    colorLog('green', `âœ… Cookieå·²ä¿å­˜åˆ°: ${cookieFile}`)
    
    // æµ‹è¯•Cookieæœ‰æ•ˆæ€§
    colorLog('cyan', 'ğŸ§ª æµ‹è¯•Cookieæœ‰æ•ˆæ€§...')
    const testResult = await testYouTubeConnection()
    
    if (testResult.working) {
      colorLog('green', 'ğŸ‰ Cookieè®¾ç½®æˆåŠŸä¸”æœ‰æ•ˆ!')
      return true
    } else {
      colorLog('red', 'âŒ Cookieæ— æ•ˆï¼Œè¯·æ£€æŸ¥å¹¶é‡æ–°è®¾ç½®')
      return false
    }
  } catch (error) {
    colorLog('red', `âŒ ä¿å­˜Cookieå¤±è´¥: ${error.message}`)
    return false
  }
}

// è®¾ç½®ç¯å¢ƒå˜é‡
async function setupEnvironmentVariables() {
  colorLog('cyan', 'ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡')
  
  const email = await question('è¯·è¾“å…¥YouTube/Googleé‚®ç®±: ')
  const password = await question('è¯·è¾“å…¥å¯†ç : ')
  
  if (!email || !password) {
    colorLog('red', 'âŒ é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©º')
    return false
  }

  // ç”Ÿæˆç¯å¢ƒå˜é‡è®¾ç½®è„šæœ¬
  const envScript = `#!/bin/bash
# YouTubeè®¤è¯ç¯å¢ƒå˜é‡
export YOUTUBE_EMAIL="${email}"
export YOUTUBE_PASSWORD="${password}"

echo "YouTubeè®¤è¯ç¯å¢ƒå˜é‡å·²è®¾ç½®"
`

  const envFile = join(projectRoot, 'youtube-env.sh')
  writeFileSync(envFile, envScript, 'utf8')
  
  colorLog('green', `âœ… ç¯å¢ƒå˜é‡è„šæœ¬å·²ç”Ÿæˆ: ${envFile}`)
  colorLog('yellow', 'è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤è®¾ç½®ç¯å¢ƒå˜é‡:')
  colorLog('white', `source ${envFile}`)
  
  return true
}

// ç”ŸæˆæœåŠ¡å™¨éƒ¨ç½²æŒ‡å—
function generateServerGuide() {
  colorLog('cyan', 'ğŸ“– UbuntuæœåŠ¡å™¨éƒ¨ç½²æŒ‡å—')
  
  const guide = `
ğŸš€ UbuntuæœåŠ¡å™¨YouTubeè®¤è¯éƒ¨ç½²æŒ‡å—

1. ç¯å¢ƒå‡†å¤‡
   sudo apt update
   sudo apt install python3 python3-pip nodejs npm
   pip3 install yt-dlp

2. é¡¹ç›®éƒ¨ç½²
   git clone <your-repo>
   cd yt-dlpservice
   npm install
   
3. è®¾ç½®YouTubeè®¤è¯ (é€‰æ‹©ä¸€ç§æ–¹æ³•)

   æ–¹æ³•A: ç¯å¢ƒå˜é‡è‡ªåŠ¨ç™»å½•
   export YOUTUBE_EMAIL="your-email@gmail.com"
   export YOUTUBE_PASSWORD="your-password"
   
   æ–¹æ³•B: æ‰‹åŠ¨è®¾ç½®Cookie
   node scripts/youtube-auth-cli.js --set-cookie
   
   æ–¹æ³•C: æœåŠ¡å™¨APIè®¾ç½®
   curl -X POST http://localhost:3000/api/youtube/auth \\
     -H "Content-Type: application/json" \\
     -d '{"action":"set-cookies","cookies":"your-cookie-string"}'

4. å¯åŠ¨æœåŠ¡
   npm run build
   npm start
   
5. éªŒè¯è®¾ç½®
   node scripts/youtube-auth-cli.js --test
   
6. ç›‘æ§å’Œç»´æŠ¤
   # æ£€æŸ¥CookieçŠ¶æ€
   node scripts/youtube-auth-cli.js --status
   
   # é‡æ–°è®¾ç½®Cookie
   node scripts/youtube-auth-cli.js --set-cookie

ğŸ“ æ³¨æ„äº‹é¡¹:
- Cookieé€šå¸¸24å°æ—¶åè¿‡æœŸï¼Œéœ€è¦å®šæœŸæ›´æ–°
- å»ºè®®ä½¿ç”¨systemdæœåŠ¡ç®¡ç†åº”ç”¨
- è®¾ç½®æ—¥å¿—è½®è½¬é¿å…æ—¥å¿—æ–‡ä»¶è¿‡å¤§
- å®šæœŸå¤‡ä»½Cookieæ–‡ä»¶

ğŸ”§ æ•…éšœæ’é™¤:
- å¦‚æœyt-dlpæŠ¥é”™"LOGIN_REQUIRED"ï¼Œè¯´æ˜éœ€è¦æ›´æ–°Cookie
- å¦‚æœè‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Œå¯èƒ½éœ€è¦åœ¨Googleè´¦å·ä¸­å¼€å¯"ä½å®‰å…¨æ€§åº”ç”¨"è®¿é—®
- æŸäº›Googleè´¦å·å¯èƒ½éœ€è¦åº”ç”¨ä¸“ç”¨å¯†ç 

Cookieæ–‡ä»¶ä½ç½®: ${cookieFile}
  `
  
  console.log(guide)
  
  // ä¿å­˜æŒ‡å—åˆ°æ–‡ä»¶
  const guideFile = join(projectRoot, 'YOUTUBE_SERVER_SETUP.md')
  writeFileSync(guideFile, guide, 'utf8')
  colorLog('green', `ğŸ“„ æŒ‡å—å·²ä¿å­˜åˆ°: ${guideFile}`)
}

// ä¸»å‡½æ•°
async function main() {
  const args = process.argv.slice(2)
  const command = args[0]

  colorLog('magenta', 'ğŸ¬ YouTubeè®¤è¯CLIå·¥å…·')
  colorLog('white', '=' .repeat(50))

  try {
    switch (command) {
      case '--status':
      case '-s':
        const status = checkCookieStatus()
        colorLog('blue', 'ğŸ“Š CookieçŠ¶æ€:')
        console.log(`  ${status.message}`)
        if (status.exists) {
          console.log(`  è·¯å¾„: ${status.path}`)
          console.log(`  å¹´é¾„: ${status.age.toFixed(1)}å°æ—¶`)
        }
        break

      case '--test':
      case '-t':
        const testUrl = args[1] || 'https://www.youtube.com/watch?v=dQw4w9WgXcQ'
        await testYouTubeConnection(testUrl)
        break

      case '--set-cookie':
      case '-c':
        await setCookieManually()
        break

      case '--env':
      case '-e':
        await setupEnvironmentVariables()
        break

      case '--guide':
      case '-g':
        generateServerGuide()
        break

      case '--help':
      case '-h':
      default:
        colorLog('cyan', 'ä½¿ç”¨æ–¹æ³•:')
        console.log(`
  node scripts/youtube-auth-cli.js [å‘½ä»¤]

å‘½ä»¤:
  --status, -s          æ£€æŸ¥CookieçŠ¶æ€
  --test, -t [url]      æµ‹è¯•YouTubeè¿é€šæ€§
  --set-cookie, -c      æ‰‹åŠ¨è®¾ç½®Cookie
  --env, -e             è®¾ç½®ç¯å¢ƒå˜é‡
  --guide, -g           ç”ŸæˆæœåŠ¡å™¨éƒ¨ç½²æŒ‡å—
  --help, -h            æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

ç¤ºä¾‹:
  node scripts/youtube-auth-cli.js --status
  node scripts/youtube-auth-cli.js --test "https://www.youtube.com/watch?v=qtYt88z_tdw"
  node scripts/youtube-auth-cli.js --set-cookie
        `)
        break
    }
  } catch (error) {
    colorLog('red', `âŒ æ‰§è¡Œå¤±è´¥: ${error.message}`)
    process.exit(1)
  } finally {
    rl.close()
  }
}

// å¦‚æœç›´æ¥è¿è¡Œæ­¤è„šæœ¬
if (import.meta.url === `file://${process.argv[1]}`) {
  main()
}