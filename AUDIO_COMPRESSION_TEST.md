# 音频压缩功能测试指南

## 功能概述

音频压缩模块已成功集成到 YT-DLP Service 中，提供三种预设压缩选项来解决音频文件过大的问题。

## 压缩预设

### 1. 轻度压缩 (Light)
- **比特率**: 128kbps
- **采样率**: 44.1kHz
- **声道**: 单声道
- **预期压缩**: 30-50%
- **适用场景**: 高质量音频需求，文件大小适中超标

### 2. 标准压缩 (Standard) - 推荐
- **比特率**: 64kbps
- **采样率**: 22.05kHz
- **声道**: 单声道
- **预期压缩**: 50-70%
- **适用场景**: 一般语音转录需求，推荐默认选项

### 3. 高度压缩 (Heavy)
- **比特率**: 32kbps
- **采样率**: 16kHz
- **声道**: 单声道
- **预期压缩**: 70-85%
- **适用场景**: 文件严重超标，对音质要求不高

## 测试步骤

### 1. 基础功能测试
1. 访问 http://localhost:3000/admin
2. 在创建任务表单中输入视频 URL
3. 选择下载类型为 "仅音频"
4. 选择不同的压缩预设
5. 创建任务并观察处理过程

### 2. 压缩效果验证
- 查看任务列表中的压缩信息显示
- 确认压缩比例和文件大小变化
- 验证压缩后的音频是否满足豆包API的80MB限制

### 3. 错误处理测试
- 测试FFmpeg不可用时的处理
- 测试压缩失败时的回退机制
- 验证日志记录是否完整

## 数据库字段

新增的压缩相关字段：
- `compressionPreset`: 压缩预设 (none/light/standard/heavy)
- `originalFileSize`: 压缩前文件大小（字节）
- `compressedFileSize`: 压缩后文件大小（字节）
- `compressionRatio`: 压缩比例 (0-1)
- `compressionDuration`: 压缩耗时（毫秒）

## API 接口更新

### 创建任务接口
```typescript
{
  url: string
  downloadType?: DownloadType
  compressionPreset?: CompressionPreset  // 新增
}
```

### 压缩预设类型
```typescript
type CompressionPreset = 'none' | 'light' | 'standard' | 'heavy'
```

## 环境配置

新增环境变量：
```env
AUDIO_COMPRESSION_ENABLED=true
AUDIO_COMPRESSION_TEMP_DIR=./temp/compression
AUDIO_COMPRESSION_MAX_SIZE=80
```

## 架构特点

### 1. 模块化设计
- `AudioCompressor`: 核心压缩服务
- `CompressionPresets`: 预设配置管理
- `AudioUtils`: 音频处理工具函数

### 2. 错误处理
- 压缩失败时自动回退到原文件
- 完整的日志记录和错误信息
- 文件验证和完整性检查

### 3. 性能优化
- 智能跳过不需要压缩的文件
- 临时文件自动清理
- FFmpeg 可用性检查

## 测试用例

### 正常流程测试
1. 使用小宇宙链接测试：`https://www.xiaoyuzhoufm.com/episode/682f4524e4350cce5ee815de`
2. 选择标准压缩预设
3. 验证压缩效果和转录成功

### 边界情况测试
1. 文件已经小于80MB时的跳过逻辑
2. FFmpeg不可用时的错误处理
3. 压缩失败时的回退机制

## 监控指标

系统会记录以下压缩统计信息：
- 压缩成功率
- 平均压缩比例
- 压缩耗时统计
- 文件大小分布

## 注意事项

1. **FFmpeg 依赖**: 确保系统已安装 FFmpeg
2. **磁盘空间**: 压缩过程需要临时存储空间
3. **处理时间**: 大文件压缩可能需要较长时间
4. **音质权衡**: 高度压缩会显著降低音质

## 故障排除

### 常见问题
1. **FFmpeg 不可用**: 检查 FFmpeg 安装和 PATH 配置
2. **压缩失败**: 查看日志中的详细错误信息
3. **磁盘空间不足**: 清理临时文件或增加存储空间

### 日志查看
压缩过程的详细日志会记录在系统日志中，包括：
- 原始文件信息
- 压缩参数
- 压缩结果统计
- 错误信息（如有）

## 未来扩展

1. **视频压缩**: 支持视频文件压缩
2. **自定义预设**: 允许用户自定义压缩参数
3. **批量压缩**: 支持多文件批量压缩
4. **压缩预览**: 压缩前预估效果 