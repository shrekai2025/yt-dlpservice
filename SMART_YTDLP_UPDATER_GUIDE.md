# ğŸ¤– æ™ºèƒ½YT-DLPè‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ

## ğŸ“‹ æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„YT-DLPè‡ªåŠ¨æ›´æ–°ç³»ç»Ÿï¼Œèƒ½å¤Ÿï¼š

- âœ… **ä»»åŠ¡æ„ŸçŸ¥**ï¼šæ£€æµ‹æ­£åœ¨æ‰§è¡Œçš„ä¸‹è½½ä»»åŠ¡ï¼Œé¿å…æ›´æ–°å†²çª
- â° **å®šæ—¶æ›´æ–°**ï¼šæ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨æ£€æŸ¥å¹¶æ›´æ–°
- ğŸ”„ **æ™ºèƒ½é‡è¯•**ï¼šå¦‚æœæœ‰ä»»åŠ¡æ‰§è¡Œï¼Œç­‰å¾…å¹¶é‡è¯•
- ğŸ“Š **çŠ¶æ€è·Ÿè¸ª**ï¼šå®Œæ•´çš„æ›´æ–°å†å²å’ŒçŠ¶æ€ç›‘æ§
- ğŸ›¡ï¸ **å®‰å…¨æœºåˆ¶**ï¼šå¼ºåˆ¶æ›´æ–°ã€æœåŠ¡é‡å¯ç­‰ä¿éšœæªæ–½

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### 1. è¿è¡Œæµ‹è¯•

é¦–å…ˆè¿è¡Œç³»ç»Ÿæµ‹è¯•ï¼Œç¡®ä¿æ‰€æœ‰ç»„ä»¶æ­£å¸¸ï¼š

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/uniteyoo/Documents/yt-dlpservice

# è¿è¡Œå®Œæ•´æµ‹è¯•
node scripts/test-updater-system.js
```

### 2. éƒ¨ç½²åˆ°PM2

å¦‚æœæµ‹è¯•é€šè¿‡ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤éƒ¨ç½²ï¼š

```bash
# åœæ­¢ç°æœ‰æœåŠ¡
pm2 stop all

# ä½¿ç”¨æ–°é…ç½®å¯åŠ¨æœåŠ¡
pm2 start ecosystem.config.cjs --env production

# ä¿å­˜PM2é…ç½®
pm2 save

# è®¾ç½®PM2å¼€æœºè‡ªå¯
pm2 startup
```

### 3. éªŒè¯éƒ¨ç½²

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 list

# æŸ¥çœ‹æ›´æ–°å™¨æ—¥å¿—
pm2 logs yt-dlp-auto-updater

# æ‰‹åŠ¨æµ‹è¯•ä»»åŠ¡æ£€æŸ¥
node scripts/task-status-checker.js

# æŸ¥çœ‹æ›´æ–°çŠ¶æ€
node scripts/update-status-tracker.js --status
```

## ğŸ”§ ç³»ç»Ÿç»„ä»¶

### 1. ä»»åŠ¡çŠ¶æ€æ£€æŸ¥å™¨ (`task-status-checker.js`)

**åŠŸèƒ½**ï¼šæ£€æµ‹æ˜¯å¦æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡

**æ£€æµ‹æ–¹æ³•**ï¼š
- æ•°æ®åº“çŠ¶æ€æ£€æŸ¥ï¼ˆPENDINGã€EXTRACTINGã€TRANSCRIBINGä»»åŠ¡ï¼‰
- è¿›ç¨‹æ£€æŸ¥ï¼ˆyt-dlpã€ffmpegè¿›ç¨‹ï¼‰
- æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥ï¼ˆä¸´æ—¶ç›®å½•æ´»è·ƒæ–‡ä»¶ï¼‰

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
# è¯¦ç»†æ£€æŸ¥
node scripts/task-status-checker.js

# ç®€å•è¾“å‡º
node scripts/task-status-checker.js --simple

# JSONæ ¼å¼
node scripts/task-status-checker.js --json

# é€€å‡ºç æ¨¡å¼ï¼ˆ0=ç©ºé—²ï¼Œ1=ç¹å¿™ï¼‰
node scripts/task-status-checker.js --exit-code
```

### 2. æ™ºèƒ½æ›´æ–°å™¨ (`smart-ytdlp-updater.js`)

**åŠŸèƒ½**ï¼šæ™ºèƒ½æ‰§è¡ŒYT-DLPæ›´æ–°

**ç‰¹æ€§**ï¼š
- ğŸ• æ—¶é—´çª—å£ï¼šåªåœ¨å‡Œæ™¨3-9ç‚¹æ‰§è¡Œ
- â³ æ™ºèƒ½ç­‰å¾…ï¼šæœ€å¤šç­‰å¾…6å°æ—¶å¯»æ‰¾å®‰å…¨æ›´æ–°çª—å£
- ğŸ”¥ å¼ºåˆ¶æ›´æ–°ï¼šè¶…è¿‡72å°æ—¶å¼ºåˆ¶æ›´æ–°
- ğŸ”„ æœåŠ¡é‡å¯ï¼šæ›´æ–°åè‡ªåŠ¨é‡å¯æœåŠ¡

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
# æ­£å¸¸æ‰§è¡Œ
node scripts/smart-ytdlp-updater.js

# å¼ºåˆ¶æ›´æ–°
node scripts/smart-ytdlp-updater.js --force

# ä»…æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
node scripts/smart-ytdlp-updater.js --check-only

# æµ‹è¯•æ¨¡å¼
node scripts/smart-ytdlp-updater.js --test

# æŸ¥çœ‹å¸®åŠ©
node scripts/smart-ytdlp-updater.js --help
```

### 3. çŠ¶æ€è·Ÿè¸ªå™¨ (`update-status-tracker.js`)

**åŠŸèƒ½**ï¼šè®°å½•å’Œç›‘æ§æ›´æ–°çŠ¶æ€

**ç‰¹æ€§**ï¼š
- ğŸ“ çŠ¶æ€è®°å½•ï¼šè®°å½•æ¯æ¬¡æ›´æ–°çš„è¯¦ç»†ä¿¡æ¯
- ğŸ“Š ç»Ÿè®¡åˆ†æï¼šæˆåŠŸç‡ã€æ›´æ–°é¢‘ç‡ç­‰ç»Ÿè®¡
- ğŸ¥ å¥åº·æ£€æŸ¥ï¼šè¯„ä¼°æ›´æ–°ç³»ç»Ÿå¥åº·åº¦
- ğŸ“š å†å²ç®¡ç†ï¼šè‡ªåŠ¨æ¸…ç†æ—§è®°å½•

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
# æŸ¥çœ‹å½“å‰çŠ¶æ€
node scripts/update-status-tracker.js --status

# æŸ¥çœ‹æ›´æ–°å†å²
node scripts/update-status-tracker.js --history 20

# ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
node scripts/update-status-tracker.js --report

# å¥åº·æ£€æŸ¥
node scripts/update-status-tracker.js --health

# æ‰‹åŠ¨è®°å½•çŠ¶æ€
node scripts/update-status-tracker.js --record success "æ‰‹åŠ¨æ›´æ–°å®Œæˆ"
```

### 4. ç³»ç»Ÿæµ‹è¯•å™¨ (`test-updater-system.js`)

**åŠŸèƒ½**ï¼šå…¨é¢æµ‹è¯•æ›´æ–°ç³»ç»Ÿ

**æµ‹è¯•é¡¹ç›®**ï¼š
- ä»»åŠ¡çŠ¶æ€æ£€æŸ¥å™¨åŠŸèƒ½
- çŠ¶æ€è·Ÿè¸ªå™¨åŠŸèƒ½
- PM2é…ç½®éªŒè¯
- ç³»ç»Ÿé›†æˆæµ‹è¯•

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•
node scripts/test-updater-system.js

# JSONæ ¼å¼è¾“å‡º
node scripts/test-updater-system.js --json
```

## âš™ï¸ é…ç½®è¯´æ˜

### PM2é…ç½® (`ecosystem.config.cjs`)

æ–°å¢çš„æ›´æ–°ä»»åŠ¡é…ç½®ï¼š

```javascript
{
  name: 'yt-dlp-auto-updater',
  script: 'node',
  args: 'scripts/smart-ytdlp-updater.js',
  cron_restart: '0 3 * * *',    // æ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œ
  autorestart: false,           // æ‰§è¡Œå®Œæˆåä¸é‡å¯
  // ... å…¶ä»–é…ç½®
}
```

### æ—¶é—´é…ç½®

å¯ä»¥åœ¨ `smart-ytdlp-updater.js` ä¸­ä¿®æ”¹ä»¥ä¸‹å‚æ•°ï¼š

```javascript
const CONFIG = {
  MAX_WAIT_HOURS: 6,           // æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆå°æ—¶ï¼‰
  RETRY_INTERVAL_MINUTES: 30,  // é‡è¯•é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
  FORCE_UPDATE_HOURS: 72,      // å¼ºåˆ¶æ›´æ–°é—´éš”ï¼ˆå°æ—¶ï¼‰
  UPDATE_WINDOW_START: 3,      // æ›´æ–°çª—å£å¼€å§‹æ—¶é—´
  UPDATE_WINDOW_END: 9,        // æ›´æ–°çª—å£ç»“æŸæ—¶é—´
}
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
yt-dlpservice/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ task-status-checker.js      # ä»»åŠ¡çŠ¶æ€æ£€æŸ¥å™¨
â”‚   â”œâ”€â”€ smart-ytdlp-updater.js      # æ™ºèƒ½æ›´æ–°å™¨
â”‚   â”œâ”€â”€ update-status-tracker.js    # çŠ¶æ€è·Ÿè¸ªå™¨
â”‚   â”œâ”€â”€ test-updater-system.js      # ç³»ç»Ÿæµ‹è¯•å™¨
â”‚   â””â”€â”€ update-ytdlp.sh            # åŸå§‹æ›´æ–°è„šæœ¬
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ ytdlp-updater.log          # æ›´æ–°å™¨æ—¥å¿—
â”‚   â”œâ”€â”€ ytdlp-update-status.json   # å½“å‰çŠ¶æ€
â”‚   â”œâ”€â”€ ytdlp-update-history.json  # æ›´æ–°å†å²
â”‚   â”œâ”€â”€ updater-out.log            # PM2è¾“å‡ºæ—¥å¿—
â”‚   â”œâ”€â”€ updater-error.log          # PM2é”™è¯¯æ—¥å¿—
â”‚   â””â”€â”€ updater-combined.log       # PM2åˆå¹¶æ—¥å¿—
â””â”€â”€ ecosystem.config.cjs           # PM2é…ç½®æ–‡ä»¶
```

## ğŸ¯ å·¥ä½œæµç¨‹

### è‡ªåŠ¨æ›´æ–°æµç¨‹

1. **å®šæ—¶è§¦å‘**ï¼šPM2åœ¨æ¯å¤©å‡Œæ™¨3ç‚¹å¯åŠ¨æ›´æ–°ä»»åŠ¡
2. **æ—¶é—´æ£€æŸ¥**ï¼šéªŒè¯æ˜¯å¦åœ¨æ›´æ–°çª—å£å†…ï¼ˆ3-9ç‚¹ï¼‰
3. **ä»»åŠ¡æ£€æµ‹**ï¼šæ£€æŸ¥æ•°æ®åº“ã€è¿›ç¨‹ã€æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ´»è·ƒä»»åŠ¡
4. **æ™ºèƒ½ç­‰å¾…**ï¼šå¦‚æœ‰ä»»åŠ¡æ‰§è¡Œï¼Œæ¯30åˆ†é’Ÿé‡è¯•ä¸€æ¬¡ï¼Œæœ€å¤šç­‰å¾…6å°æ—¶
5. **æ‰§è¡Œæ›´æ–°**ï¼šè°ƒç”¨åŸå§‹æ›´æ–°è„šæœ¬æ›´æ–°YT-DLP
6. **æœåŠ¡é‡å¯**ï¼šæ›´æ–°æˆåŠŸåé‡å¯ä¸»æœåŠ¡
7. **çŠ¶æ€è®°å½•**ï¼šè®°å½•æ›´æ–°ç»“æœå’Œè¯¦ç»†ä¿¡æ¯

### ä»»åŠ¡æ£€æµ‹é€»è¾‘

```
æ•°æ®åº“æ£€æŸ¥ â†’ æ˜¯å¦æœ‰ PENDING/EXTRACTING/TRANSCRIBING ä»»åŠ¡ï¼Ÿ
     â†“
è¿›ç¨‹æ£€æŸ¥ â†’ æ˜¯å¦æœ‰ yt-dlp/ffmpeg è¿›ç¨‹è¿è¡Œï¼Ÿ
     â†“  
æ–‡ä»¶æ£€æŸ¥ â†’ ä¸´æ—¶ç›®å½•æ˜¯å¦æœ‰æœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶ï¼Ÿ
     â†“
ç»¼åˆåˆ¤æ–­ â†’ ç³»ç»Ÿæ˜¯å¦ç©ºé—²å¯ä»¥æ›´æ–°ï¼Ÿ
```

## ğŸ” ç›‘æ§å’Œæ•…éšœæ’é™¤

### ç›‘æ§å‘½ä»¤

```bash
# æŸ¥çœ‹PM2æœåŠ¡çŠ¶æ€
pm2 list

# å®æ—¶æŸ¥çœ‹æ›´æ–°å™¨æ—¥å¿—
pm2 logs yt-dlp-auto-updater --lines 50

# æŸ¥çœ‹æ›´æ–°çŠ¶æ€
node scripts/update-status-tracker.js --health

# æ£€æŸ¥ç³»ç»Ÿå¥åº·åº¦
node scripts/test-updater-system.js
```

### å¸¸è§é—®é¢˜

**1. æ›´æ–°ä»»åŠ¡ä¸æ‰§è¡Œ**
```bash
# æ£€æŸ¥PM2é…ç½®
pm2 describe yt-dlp-auto-updater

# æ£€æŸ¥croné…ç½®
pm2 logs yt-dlp-auto-updater | grep cron

# æ‰‹åŠ¨è§¦å‘æ›´æ–°
pm2 restart yt-dlp-auto-updater
```

**2. æ›´æ–°å¤±è´¥**
```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs yt-dlp-auto-updater --err

# æ£€æŸ¥æ›´æ–°çŠ¶æ€
node scripts/update-status-tracker.js --status

# æ‰‹åŠ¨æ›´æ–°æµ‹è¯•
bash scripts/update-ytdlp.sh
```

**3. ä»»åŠ¡æ£€æµ‹ä¸å‡†ç¡®**
```bash
# æµ‹è¯•ä»»åŠ¡æ£€æŸ¥å™¨
node scripts/task-status-checker.js

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
node scripts/test-updater-system.js
```

### å¼ºåˆ¶æ›´æ–°

å¦‚æœéœ€è¦ç«‹å³æ›´æ–°ï¼Œä¸ç­‰å¾…ä»»åŠ¡å®Œæˆï¼š

```bash
# æ–¹æ³•1ï¼šæ‰‹åŠ¨æ‰§è¡Œå¼ºåˆ¶æ›´æ–°
node scripts/smart-ytdlp-updater.js --force

# æ–¹æ³•2ï¼šç›´æ¥æ‰§è¡ŒåŸå§‹æ›´æ–°è„šæœ¬
bash scripts/update-ytdlp.sh --restart-service
```

## ğŸ“Š çŠ¶æ€è¯´æ˜

### æ›´æ–°çŠ¶æ€

- `success`ï¼šæ›´æ–°æˆåŠŸ
- `failed`ï¼šæ›´æ–°å¤±è´¥
- `skipped`ï¼šè·³è¿‡æ›´æ–°ï¼ˆæœ‰ä»»åŠ¡æ‰§è¡Œï¼‰
- `partial`ï¼šéƒ¨åˆ†æˆåŠŸï¼ˆæ›´æ–°æˆåŠŸä½†æœåŠ¡é‡å¯å¤±è´¥ï¼‰
- `error`ï¼šæ›´æ–°è¿‡ç¨‹å¼‚å¸¸

### å¥åº·çŠ¶æ€

- `healthy`ï¼šç³»ç»Ÿæ­£å¸¸ï¼ˆ80-100åˆ†ï¼‰
- `warning`ï¼šéœ€è¦æ³¨æ„ï¼ˆ60-79åˆ†ï¼‰
- `critical`ï¼šéœ€è¦ç´§æ€¥å¤„ç†ï¼ˆ0-59åˆ†ï¼‰

## ğŸ› ï¸ é«˜çº§é…ç½®

### ä¿®æ”¹æ›´æ–°æ—¶é—´

ç¼–è¾‘ `ecosystem.config.cjs`ï¼š

```javascript
// æ¯å¤©å‡Œæ™¨2ç‚¹
cron_restart: '0 2 * * *'

// æ¯ä¸¤å¤©å‡Œæ™¨3ç‚¹
cron_restart: '0 3 */2 * *'

// æ¯å‘¨æ—¥å‡Œæ™¨4ç‚¹
cron_restart: '0 4 * * 0'
```

### è‡ªå®šä¹‰æ£€æŸ¥é€»è¾‘

å¯ä»¥ä¿®æ”¹ `task-status-checker.js` ä¸­çš„æ£€æŸ¥é€»è¾‘ï¼š

```javascript
// è°ƒæ•´è¶…æ—¶æ—¶é—´
const timeoutThreshold = 15 * 60 * 1000 // æ”¹ä¸º15åˆ†é’Ÿ

// è°ƒæ•´æ–‡ä»¶æ´»è·ƒæ—¶é—´
const recentThreshold = 10 * 60 * 1000 // æ”¹ä¸º10åˆ†é’Ÿ
```

### æ·»åŠ é€šçŸ¥

å¯ä»¥åœ¨æ›´æ–°æˆåŠŸ/å¤±è´¥æ—¶å‘é€é€šçŸ¥ï¼Œä¿®æ”¹ `smart-ytdlp-updater.js`ï¼š

```javascript
// åœ¨æ›´æ–°æˆåŠŸåæ·»åŠ 
if (updateResult.success) {
  // å‘é€æˆåŠŸé€šçŸ¥
  await sendNotification('YT-DLPæ›´æ–°æˆåŠŸ', details)
}
```

## ğŸ‰ æ€»ç»“

è¿™ä¸ªæ™ºèƒ½æ›´æ–°ç³»ç»Ÿç¡®ä¿äº†ï¼š

1. **é¿å…å†²çª**ï¼šæ™ºèƒ½æ£€æµ‹ä»»åŠ¡çŠ¶æ€ï¼Œä¸ä¼šåœ¨ä¸‹è½½è¿‡ç¨‹ä¸­æ›´æ–°
2. **è‡ªåŠ¨åŒ–**ï¼šå®Œå…¨è‡ªåŠ¨åŒ–çš„æ›´æ–°æµç¨‹ï¼Œæ— éœ€äººå·¥å¹²é¢„
3. **å¯é æ€§**ï¼šå¤šé‡æ£€æŸ¥ã€é‡è¯•æœºåˆ¶ã€å¼ºåˆ¶æ›´æ–°ä¿éšœ
4. **å¯ç›‘æ§**ï¼šå®Œæ•´çš„æ—¥å¿—ã€çŠ¶æ€è·Ÿè¸ªå’Œå¥åº·æ£€æŸ¥
5. **å¯ç»´æŠ¤**ï¼šè¯¦ç»†çš„æµ‹è¯•ã€æ¸…æ™°çš„é…ç½®å’Œæ•…éšœæ’é™¤æŒ‡å—

éƒ¨ç½²åï¼Œä½ çš„YT-DLPå°†å§‹ç»ˆä¿æŒæœ€æ–°ç‰ˆæœ¬ï¼Œé¿å…å› ç‰ˆæœ¬è¿‡æ—§å¯¼è‡´çš„ä¸‹è½½å¤±è´¥é—®é¢˜ï¼
